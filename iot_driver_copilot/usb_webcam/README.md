USB Webcam HTTP Driver (UVC to HTTP)

This driver connects to a USB webcam using its native UVC interface (via OpenCV) and exposes an HTTP server with two endpoints:

- GET /stream — Live MJPEG stream (multipart/x-mixed-replace)
- GET /frame — Capture a single JPEG frame

It maintains a background capture loop with timeout, retry, and exponential backoff, and serves the latest frame from a thread-safe buffer.

Requirements

- Python 3.8+
- A UVC-compatible USB webcam
- OpenCV for Python

Install

- pip install -r requirements.txt

Configuration (Environment Variables)

All configuration must come from environment variables. Required variables:

- HTTP_HOST: Host/IP to bind the HTTP server (e.g., 0.0.0.0)
- HTTP_PORT: Port to bind the HTTP server (e.g., 8000)
- CAMERA_PATH: Device path (e.g., /dev/video0) — optional alternative to CAMERA_INDEX
- CAMERA_INDEX: Camera index (e.g., 0) — required if CAMERA_PATH not set
- BACKOFF_INITIAL_MS: Initial retry backoff in milliseconds (e.g., 200)
- BACKOFF_MAX_MS: Maximum retry backoff in milliseconds (e.g., 5000)
- BACKOFF_MULTIPLIER: Exponential backoff multiplier (>= 1.0, e.g., 1.5)
- STALE_TIMEOUT_SEC: Consider the camera disconnected if no successful frame for this many seconds (e.g., 3)
- LOOP_SLEEP_MS: Minimum sleep between capture loop iterations (e.g., 10)
- STREAM_MIN_INTERVAL_MS: Minimum interval between MJPEG frames per client in milliseconds (e.g., 50)
- JPEG_QUALITY: JPEG quality (1-100, e.g., 85)
- LOG_LEVEL: Logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL)

Optional variables (applied if provided):

- FRAME_WIDTH: Desired frame width (e.g., 1280)
- FRAME_HEIGHT: Desired frame height (e.g., 720)
- FRAME_RATE: Desired capture FPS (e.g., 30)

Run

- Export environment variables, then run: python driver.py

Example

- export HTTP_HOST=0.0.0.0
- export HTTP_PORT=8000
- export CAMERA_INDEX=0
- export BACKOFF_INITIAL_MS=200
- export BACKOFF_MAX_MS=5000
- export BACKOFF_MULTIPLIER=1.5
- export STALE_TIMEOUT_SEC=3
- export LOOP_SLEEP_MS=10
- export STREAM_MIN_INTERVAL_MS=50
- export JPEG_QUALITY=85
- export LOG_LEVEL=INFO
- python driver.py

API

- GET /frame
  - Captures and returns the latest available frame as a JPEG image.
  - Example: curl -v http://localhost:8000/frame --output snapshot.jpg

- GET /stream
  - Returns a multipart/x-mixed-replace MJPEG stream for live preview.
  - Open in a web browser: http://localhost:8000/stream
  - CLI example: curl -v http://localhost:8000/stream

Notes

- The driver implements a background capture loop with exponential backoff and stale-frame timeout. It will attempt to reconnect automatically if the camera becomes unavailable.
- For MJPEG streaming, each client receives the most recent frames at or below STREAM_MIN_INTERVAL_MS cadence.

Generated by [IoT Driver Copilot](https://copilot.test.shifu.dev/)
